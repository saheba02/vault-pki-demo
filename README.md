# vault-pki-demo
This is fork of github.com/kaparora/vault-pki-demo
by Kapil Arora


###########################################################
https://www.youtube.com/watch?v=4cEWxROsgW4
HashiCorp Vault PKI secret engine demo

[ec2-user@ip-172-31-30-13 ~]$ cat README_vault
# 3.90.200.209

@ if self sign tls is used for vault
then all vault cli needs to set this flag
export VAULT_CACERT="/opt/vault/tls/tmp/rootCA.crt"

### enable audit logs
[root@ip-172-31-30-13 vault-pki-demo]# vault audit list -detailed
Path     Type    Description    Replication    Options
----     ----    -----------    -----------    -------
file/    file    n/a            replicated     file_path=/opt/vault/logging/audit.log

vault audit enable -path="file_raw" file log_raw=true file_path=/opt/vault/logging/audit_raw.log
Success! Enabled the file audit device at: file_raw/

[root@ip-172-31-30-13 vault-pki-demo]# vault audit list -detailed
Path         Type    Description    Replication    Options
----         ----    -----------    -----------    -------
file/        file    n/a            replicated     file_path=/opt/vault/logging/audit.log
file_raw/    file    n/a            replicated     log_raw=true file_path=/opt/vault/logging/audit_raw.log

### enable self ca authority. if you have AD, then no need to use this step
[root@ip-172-31-30-13 vault-pki-demo]# vault secrets enable pki
Success! Enabled the pki secrets engine at: pki/
[root@ip-172-31-30-13 vault-pki-demo]#
[root@ip-172-31-30-13 vault-pki-demo]# vault secrets tune -max-lease-ttl=87600h pki
Success! Tuned the secrets engine at: pki/
[root@ip-172-31-30-13 vault-pki-demo]#

# generate ca
[root@ip-172-31-30-13 vault-pki-demo]# vault write -format=json pki/root/generate/internal common_name="example.com" ttl=87600h > pki-ca-root.json
# so this json file has ca which will be used for client csr to sign with

# now save in pem format file
[root@ip-172-31-30-13 vault-pki-demo]# cat pki-ca-root.json | jq -r .data.certificate > ca.pem

# now publish url for root ca, so it can be valid via client cert to validate it
[root@ip-172-31-30-13 demo1]# vault write pki/config/urls issuing_certificates="https://vault-1.example.com:8200/v1/pki/ca" crl_distribution_points="https://vault-1.example.com:8200/v1/pki/crl"
Success! Data written to: pki/config/urls

### so now we done with ca part. next is inter ca which will be one who will issue cert to client request
[root@ip-172-31-30-13 demo1]# vault secrets enable -path=pki_int pki
Success! Enabled the pki secrets engine at: pki_int/

[root@ip-172-31-30-13 demo1]# vault secrets tune -max-lease-ttl=2400h pki_int
Success! Tuned the secrets engine at: pki_int/

# create csr
[root@ip-172-31-30-13 demo1]# vault write -format=json pki_int/intermediate/generate/internal common_name="example.com Intermediate Authority"   | jq -r '.data.csr' > pki_intermediate.csr

# sign this csr with vautl CA or your own CA
[root@ip-172-31-30-13 demo1]# vault write -format=json pki/root/sign-intermediate csr=@pki_intermediate.csr format=pem_bundle ttl="2400h" | jq -r '.data.certificate' > intermediate.cert.pem

# get sign cert from ca and send back to int ca
[root@ip-172-31-30-13 demo1]# vault write pki_int/intermediate/set-signed certificate=@intermediate.cert.pem
Success! Data written to: pki_int/intermediate/set-signed

# publish this in ca urls
[root@ip-172-31-30-13 demo1]# vault write pki_int/config/urls issuing_certificates="https://vault-1.example.com:8200/v1/pki_int/ca" crl_distribution_points="https://vault-1.example.com:8200/v1/pki_int/crl"
Success! Data written to: pki_int/config/urls

### now create role which can do cert task for client
# so when new client cert generated by calling this role, cert is valid for 2 hours only
[root@ip-172-31-30-13 demo1]# vault write pki_int/roles/example-dot-com allowed_domains="example.com" allow_subdomains=true max_ttl=2h
Success! Data written to: pki_int/roles/example-dot-com

### create policy for user/group/ to grant access to this role/path
[root@ip-172-31-30-13 demo1]# cat pki_int.hcl
path "pki_int/issue/*" {
      capabilities = ["create", "update"]
    }

    path "pki_int/certs" {
      capabilities = ["list"]
    }

    path "pki_int/revoke" {
      capabilities = ["create", "update"]
    }

    path "pki_int/tidy" {
      capabilities = ["create", "update"]
    }

    path "pki/cert/ca" {
      capabilities = ["read"]
    }

    path "auth/token/renew" {
      capabilities = ["update"]
    }

    path "auth/token/renew-self" {
      capabilities = ["update"]
    }

[root@ip-172-31-30-13 demo1]# vault policy list
aws_policy
default
jack_policy
pki_int
root

### now lets create usera password userapassword and assign policy pki_int
[root@ip-172-31-30-13 demo1]# vault auth enable userpass
Success! Enabled userpass auth method at: userpass/
[root@ip-172-31-30-13 demo1]# vault write auth/userpass/users/usera password=userapassword token_policies="pki_int"
Success! Data written to: auth/userpass/users/usera


### now login to vault with usera and generate cert
[root@ip-172-31-30-13 demo1]# vault login -method=userpass username=usera
Password (will be hidden):
Key                    Value
---                    -----
token                  s.mhcaPtWOK9KIgTi2Evv6c8bO
token_accessor         msX9FGPlG6NJlbTtIGuU6NeA
token_duration         768h
token_renewable        true
token_policies         ["default" "pki_int"]
identity_policies      []
policies               ["default" "pki_int"]
token_meta_username    usera

[root@ip-172-31-30-13 demo1]# export VAULT_TOKEN=s.mhcaPtWOK9KIgTi2Evv6c8bO
[root@ip-172-31-30-13 demo1]#
[root@ip-172-31-30-13 demo1]# vault write -format=json pki_int/issue/example-dot-com common_name="test.example.com" > test.example.com.crt

now take out ca/key/crt from this file. ca and crt goes in one pem file
[root@ip-172-31-30-13 demo1]# cat test.example.com.crt | jq -r .data.certificate > test.example.com.pem
[root@ip-172-31-30-13 demo1]# cat test.example.com.crt | jq -r .data.issuing_ca >> test.example.com.pem
[root@ip-172-31-30-13 demo1]# cat test.example.com.crt | jq -r .data.private_key > test.example.com.key

### now lets install nginx and use this cert and veirfy
[root@ip-172-31-30-13 nginx]# curl -v http://test.example.com
or from browser http://3.90.200.209 which gives non tls/ssl page for ngins
now enable tls on this as this is not secure
add in windows hostfile
3.90.200.209 test.example.com


so once configure nginx to use pem and key file in nginx.conf
you can view site on https wich ca not veirfy as its self sign ca
so now get ca.pem and inject on windows box under trusted authority and you wont see that warning


### view currently holding certs in vault
[root@ip-172-31-30-13 nginx]# vault list pki_int/certs
Keys
----
14-8f-5d-cb-ca-2e-f5-33-16-ac-6d-3e-c5-9f-e2-f6-4d-09-25-29
4d-eb-e3-8c-7f-81-34-74-f8-70-e6-da-66-52-e3-80-5a-44-b3-4f

to read them
[root@ip-172-31-30-13 nginx]# vault read pki_int/cert/14-8f-5d-cb-ca-2e-f5-33-16-ac-6d-3e-c5-9f-e2-f6-4d-09-25-29
Key                Value
---                -----
certificate        -----BEGIN CERTIFICATE-----
MIIDvDCCAqSgAwIBAgIUFI9dy8ou9TMWrG0+xZ/i9k0JJSkwDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLZXhhbXBsZS5jb20wHhcNMjIwMTEzMTkzNDUxWhcNMjIw
NDIzMTkzNTIxWjAtMSswKQYDVQQDEyJleGFtcGxlLmNvbSBJbnRlcm1lZGlhdGUg
QXV0aG9yaXR5MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA26d5cKZa
TEGG+Ik7yVxv9+suepjCs1qo1sAWZVwXHk9/7kwQwlwKgmL/iOsIZxZkbYPrYrPY
TuqaEtd0gfOorTxViMYqwY+bxj5uUi0Is2JXmezqE6dUuf3I8TGvqVP5wMxYkT1E
mLcItoVm2H5pjx0hdae+1E0qDpfpHRt/AtMfjCNajzAJGmWl/ujLQuGDsdZ6F+mM
Drwt3SmscbdvxHXlKMu/LeHOG1SGZqOKjf1MLrv8NpabwraGRPk3itgYFXpaeB4w
3aGFBV8ncSVV8I4lGDw3HieTPDEqtoUQ8F8SZh9WRJXdfe70RRvt+rvS3Go8/3gv
42hf2v1nXpFlywIDAQABo4HqMIHnMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E
BTADAQH/MB0GA1UdDgQWBBRNE5sMQ8gCL5bzEt1+PdsXv6jRgTAfBgNVHSMEGDAW
gBSzNBUqxpfetCAPxbNh1k5SpjDjNDBGBggrBgEFBQcBAQQ6MDgwNgYIKwYBBQUH
MAKGKmh0dHBzOi8vdmF1bHQtMS5leGFtcGxlLmNvbTo4MjAwL3YxL3BraS9jYTA8
BgNVHR8ENTAzMDGgL6AthitodHRwczovL3ZhdWx0LTEuZXhhbXBsZS5jb206ODIw
MC92MS9wa2kvY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQAHWplOX4LqNc50chAfVgEn
3La8DrWpfihmrxsiE83GBDm2+PtauwU6gzjuFo8PbzJF++Z5lhAn9PFPj2ZMBoEE
Hrn6N6xAYB7Y+6R92gVe1t/Yr9r40fqNchvH+BcTmNz7w0TpdOCYpENPTRV+NS6m
CrsPmGnlWTkddUo+8tswWoxPwk6LFMq1Lx1k7yerc70I40389ROYyycR4GnQDx4r
X2LQS6n76XKfQ7fcLk1u/cEBGji6NijUDLFEPZo93lt6gZUDTCGnURxjQysEFpfO
riycLAMSftObpqACYiK2nMCnAODS5aYgXXRwFOYcaJy6+5VDhVxWMb6yV9VTYtBZ
-----END CERTIFICATE-----
revocation_time    0

so last line tells its not revoke yet
you can save this BEGIN and END block and view via openssl x509 -noout -text

so by checking via openssl, 4d-eb-e3-8c-7f-81-34-74-f8-70-e6-da-66-52-e3-80-5a-44-b3-4f serial number belongs to test.exmaple.com


[root@ip-172-31-30-13 demo1]# vault list pki_int/certs
Keys
----
14-8f-5d-cb-ca-2e-f5-33-16-ac-6d-3e-c5-9f-e2-f6-4d-09-25-29
25-ec-5f-52-7d-57-2e-4c-d9-10-1d-24-66-f0-fb-c6-d9-41-c2-c4
4b-0d-be-75-c7-e1-2e-77-57-0a-3e-4e-51-13-44-44-fa-16-81-34
4d-eb-e3-8c-7f-81-34-74-f8-70-e6-da-66-52-e3-80-5a-44-b3-4f
[root@ip-172-31-30-13 demo1]# vault list pki/certs
Keys
----
14-8f-5d-cb-ca-2e-f5-33-16-ac-6d-3e-c5-9f-e2-f6-4d-09-25-29
34-14-a3-1e-c2-99-86-6a-1f-3c-05-71-ab-a9-55-90-8b-37-87-d9
36-2c-7c-00-f2-67-36-c8-f5-7b-fe-a2-97-57-75-42-87-e6-73-4f
4b-0d-be-75-c7-e1-2e-77-57-0a-3e-4e-51-13-44-44-fa-16-81-34


 now lets revoke it
by viewing certs, serial #25-ec-5f-52-7d-57-2e-4c-d9-10-1d-24-66-f0-fb-c6-d9-41-c2-c4 is expired
so lets revoke it and then delete it
[root@ip-172-31-30-13 demo1]# vault write pki_int/revoke serial_number=25-ec-5f-52-7d-57-2e-4c-d9-10-1d-24-66-f0-fb-c6-d9-41-c2-c4
Key                        Value
---                        -----
revocation_time            1642107051
revocation_time_rfc3339    2022-01-13T20:50:51.516250214Z
[root@ip-172-31-30-13 demo1]# vault read pki_int/cert/25-ec-5f-52-7d-57-2e-4c-d9-10-1d-24-66-f0-fb-c6-d9-41-c2-c4
Key                Value
---                -----
certificate        -----BEGIN CERTIFICATE-----
..
...
-----END CERTIFICATE-----
revocation_time    1642107051

so now u can see its revoked.
now delete it
[root@ip-172-31-30-13 demo1]#  vault write pki_int/tidy safety_buffers=5s tidy_cert_store=true tidy_revocation_list=true
WARNING! The following warnings were returned from Vault:

  * Tidy operation successfully started. Any information from the operation
  will be printed to Vault's server logs.

so now whenever need to generate new cleint cert, just get login with auth method (userpass for ex)
set VAULT_TOKEN varibale
and run vault write on pki_int/issue/example-dot-com and pass common_name which gives you crt 
use this crt and split in key/ca/client file and use them in pem format and done.

####################
https://www.youtube.com/watch?v=ZWaKF-UXtx8
Hashicorp Vault PKI Secrets Engine Demo for Certificate Management
####################
https://www.youtube.com/watch?v=bZ803OZabTg
Advanced Data Protection With HashiCorp Vault masking/encryption for db

